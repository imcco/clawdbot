name: Fork Sync (Working)

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all forks'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Git
      run: |
        git config --global user.name 'OpenClaw Fork Sync'
        git config --global user.email 'openclaw@localhost'
        
    - name: Sync Fork Repository
      env:
        FORK_SYNC_PAT: ${{ secrets.FORK_SYNC_PAT }}
      run: |
        echo "ðŸ”„ Starting fork sync for ${{ github.repository }}"
        echo "ðŸ“ Repository: ${{ github.repository }}"
        echo "ðŸŽ¯ Event: ${{ github.event_name }}"
        
        # ç®€åŒ–è€Œæœ‰æ•ˆçš„åŒæ­¥é€»è¾‘
        echo "ðŸ”§ Setting up GitHub CLI..."
        
        # ä½¿ç”¨echoåˆ›å»ºä¸´æ—¶è®¤è¯æ–‡ä»¶
        echo "$FORK_SYNC_PAT" | gh auth login --with-token
        
        # éªŒè¯è®¤è¯
        echo "âœ… Verifying authentication..."
        gh auth status
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºfork
        echo "ðŸ” Checking fork status..."
        IS_FORK=$(gh repo view --json=fork --jq '.fork')
        
        if [ "$IS_FORK" = "true" ]; then
          echo "âœ… This is a fork repository"
          
          # èŽ·å–ä¸Šæ¸¸ä»“åº“ä¿¡æ¯
          UPSTREAM_OWNER=$(gh repo view --json=parent --jq '.parent.owner.login')
          UPSTREAM_REPO=$(gh repo view --json=parent --jq '.parent.name')
          UPSTREAM_URL="https://github.com/$UPSTREAM_OWNER/$UPSTREAM_REPO"
          
          echo "ðŸ”— Upstream repository: $UPSTREAM_URL"
          
          # è®¾ç½®ä¸Šæ¸¸è¿œç¨‹
          git remote add upstream "$UPSTREAM_URL" 2>/dev/null || true
          git remote set-url upstream "$UPSTREAM_URL"
          
          # èŽ·å–ä¸Šæ¸¸æ›´æ–°
          echo "ðŸ“¥ Fetching upstream updates..."
          git fetch upstream
          git fetch origin
          
          # èŽ·å–å½“å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git branch --show-current)
          echo "ðŸŒ¿ Current branch: $CURRENT_BRANCH"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ›´æ–°
          LOCAL_COMMIT=$(git rev-parse "origin/$CURRENT_BRANCH")
          UPSTREAM_COMMIT=$(git rev-parse "upstream/$CURRENT_BRANCH")
          
          if [ "$LOCAL_COMMIT" = "$UPSTREAM_COMMIT" ]; then
            echo "âœ… Repository is up to date with upstream"
          else
            echo "ðŸ“Š Updates detected, syncing..."
            
            # æ‰§è¡ŒåŒæ­¥
            git reset --ff-only "upstream/$CURRENT_BRANCH"
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦æŽ¨é€
            if [ "$(git rev-parse HEAD)" != "$(git rev-parse "origin/$CURRENT_BRANCH")" ]; then
              echo "ðŸš€ Pushing updates..."
              git push --force-with-lease origin "$CURRENT_BRANCH"
              echo "âœ… Sync completed successfully"
            else
              echo "âœ… No changes to push"
            fi
          fi
        else
          echo "â„¹ï¸ This is not a fork repository, skipping sync"
        fi
        
    - name: Sync Summary
      if: always()
      run: |
        echo "## ðŸ”„ Fork Sync Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Sync Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "**Force Sync**: ${{ github.event.inputs.force_sync }}" >> $GITHUB_STEP_SUMMARY
        fi